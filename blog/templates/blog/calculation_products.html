<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Агрегатор товаров и услуг</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; margin:20px; background:#f7f7f8; }
.top-row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:18px; }
.date-input { display:flex; gap:6px; align-items:center; }
input[type="datetime-local"] { padding:6px 8px; border-radius:6px; border:1px solid #ccc; }
button { padding:8px 12px; border-radius:6px; border:none; background:#2b6cb0; color:white; cursor:pointer; }
button:disabled { opacity:0.6; cursor:not-allowed; }

.products-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-bottom:18px; }
@media(max-width:1100px){.products-grid{grid-template-columns:repeat(4,1fr);}}
@media(max-width:700px){.products-grid{grid-template-columns:repeat(2,1fr);}}

.product-tile { background:white; padding:10px; border-radius:8px; border:2px solid transparent; box-shadow:0 1px 3px rgba(0,0,0,0.06); cursor:pointer; display:flex; align-items:center; justify-content:center; min-height:56px; font-weight:600; }
.product-tile.selected { border-color:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,0.08); background:#f7fff7; }

.chart-container { margin-top:22px; background:white; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); max-width:900px; margin-left:auto; margin-right:auto;}
.no-data { padding:12px; color:#777; text-align:center; }

.table-container { max-width:900px; margin:20px auto; background:white; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { background:#eee; }
</style>
</head>
<body>
<h1>История покупок и услуг</h1>

<div class="top-row">
  <div class="date-input"><label for="start">Дата от</label><input id="start" type="datetime-local"/></div>
  <div class="date-input"><label for="end">До</label><input id="end" type="datetime-local"/></div>
  <button id="applyBtn">Применить</button>
</div>

<div class="products-grid" id="productsGrid">
  {% for p in product_names %}
    <div class="product-tile" data-name="{{ p|escape }}">{{ p }}</div>
  {% endfor %}
</div>
<div><small>Клик — выбрать/снять выбор. Можно выбрать несколько товаров/услуг.</small></div>

<div class="chart-container" id="chartWrap" style="display:none;">
  <canvas id="aggChart" width="900" height="400"></canvas>
</div>
<div id="noDataMsg" class="no-data" style="display:none;">Нет данных по выбранным товарам и услугам в диапазоне дат.</div>

<div class="table-container" id="tableContainer" style="display:none;">
  <h3>Подробности по товарам и услугам</h3>
  <table>
    <thead>
      <tr>
        <th>Товар/Услуга</th>
        <th>Даты</th>
        <th>Итого</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
const tiles = Array.from(document.querySelectorAll('.product-tile'));
const applyBtn = document.getElementById('applyBtn');
const startInput = document.getElementById('start');
const endInput = document.getElementById('end');
const chartWrap = document.getElementById('chartWrap');
const noDataMsg = document.getElementById('noDataMsg');
const tableContainer = document.getElementById('tableContainer');
const tableBody = document.getElementById('tableBody');
let chart = null;

tiles.forEach(tile=>{
  tile.addEventListener('click',()=>{tile.classList.toggle('selected');});
});

function getCookie(name){
  let cookieValue = null;
  if(document.cookie && document.cookie!==''){
    const cookies=document.cookie.split(';');
    for(let i=0;i<cookies.length;i++){
      const cookie=cookies[i].trim();
      if(cookie.substring(0,name.length+1)===name+'='){
        cookieValue=decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

applyBtn.addEventListener('click', async ()=>{
  const selected = tiles.filter(t=>t.classList.contains('selected')).map(t=>t.dataset.name);
  if(selected.length===0){alert('Выберите хотя бы один товар/услугу'); return;}
  const start = startInput.value;
  const end = endInput.value;
  if(!start || !end){alert('Укажите обе даты'); return;}
  applyBtn.disabled=true; applyBtn.textContent='Загрузка...';



function handleResponse(data){
  // Проверка наличия данных
  const hasData = Object.values(data).some(arr=>arr.length>0);
  if(!hasData){chartWrap.style.display='none'; tableContainer.style.display='none'; noDataMsg.style.display='block'; return;}
  noDataMsg.style.display='none'; chartWrap.style.display='block'; tableContainer.style.display='block';

  // --- График ---
  const dateSet = new Set();
  Object.values(data).forEach(arr=>arr.forEach(r=>dateSet.add(r.date)));
  const sortedDates = Array.from(dateSet).sort();
  const labels = sortedDates.map(d=>{ const dt = new Date(d+'T00:00:00'); return dt.toLocaleDateString('ru-RU',{day:'2-digit', month:'short'}); });

  const palette=['#ef4444','#f97316','#f59e0b','#eab308','#84cc16','#16a34a','#059669','#0ea5e9','#3b82f6','#6366f1','#8b5cf6','#ec4899'];
  const datasets=[]; let idx=0;
  for(const [product, arr] of Object.entries(data)){
    const map={}; arr.forEach(r=>map[r.date]=r.count);
    datasets.push({
      label: product,
      data: sortedDates.map(d=>map[d]||0),
      borderColor: palette[idx%palette.length],
      backgroundColor: palette[idx%palette.length],
      fill:false,
      tension:0.2,
      pointRadius:4
    });
    idx++;
  }

  const ctx = document.getElementById('aggChart').getContext('2d');
  if(chart){chart.data.labels=labels; chart.data.datasets=datasets; chart.update();}
  else{chart = new Chart(ctx,{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      stacked:false,
      plugins:{
        title:{display:true,text:'Динамика продаж по товарам/услугам'},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.formattedValue}`}},
        legend:{position:'bottom'}
      },
      scales:{y:{beginAtZero:true,title:{display:true,text:'Количество'}},x:{title:{display:true,text:'Дата'}}}
    }
  });}

  // --- Таблица ---
  tableBody.innerHTML = '';
  for(const [product, arr] of Object.entries(data)){
    const dates = arr.map(r=>{const dt = new Date(r.date+'T00:00:00'); return dt.toLocaleDateString('ru-RU',{day:'2-digit',month:'short'});});
    const total = arr.reduce((sum,r)=>sum+r.count,0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${product}</td><td>${dates.join(', ')}</td><td>${total}</td>`;
    tableBody.appendChild(tr);
  }
}
</script>
</body>
</html>
